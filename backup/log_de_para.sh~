#!/bin/sh

# US9979: Relatório de categorias pendentes por parceiro.
# Exporta diariamente os de/para ativos e pendentes de todos os parceiros, contendo:
#     * "parceiro", "parceiro_ativo", "categoria_xml", "categoria_cap" (vazia se não houver de/para), "produtos_perdidos"
#     * nome do arquivo:  cap-depara_parceiros-YYYYMMDD.csv.zip

# local onde deve ser gerado o csv
output="/tmp/"

# nome do arquivo
file_name="cap-depara_parceiros-$(date +%Y%m%d).csv"

# query
    sql="select 'Nome Parceiro', "
sql=$sql"       'Parceiro Ativo', "
sql=$sql"       'Descricao Categoria XML', "
sql=$sql"       'Categoria CAP', "
sql=$sql"       'Departamento', "
sql=$sql"       'Produtos Perdidos' "
sql=$sql"   union all "
sql=$sql"   select tb_parceiros.display_name as parceiro, "
sql=$sql"          tb_parceiros.registro_ativo as parceiro_ativo, "
sql=$sql"          tb_categoria_parceiro.descricao_categoria as categoria_xml, "
sql=$sql"          tb_categoria.categoria as categoria_cap, "
sql=$sql"          tb_tipo_produto.tipo as departamento, "
sql=$sql"          0 produtos_perdidos "
sql=$sql"     from tb_parceiros "
sql=$sql"    inner join tb_categoria_parceiro on "
sql=$sql"          tb_categoria_parceiro.parceiro_id = tb_parceiros.id "
sql=$sql"    inner join tb_categoria on "
sql=$sql"          tb_categoria.id = tb_categoria_parceiro.categoria_id "
sql=$sql"    inner join tb_produtos on "
sql=$sql"          tb_produtos.categoria_id = tb_categoria.id "
sql=$sql"    inner join tb_tipo_produto on "
sql=$sql"          tb_tipo_produto.id = tb_produtos.tipo_produto_id "
sql=$sql"      where "
sql=$sql"          tb_produtos.registro_ativo = 'S' and "
sql=$sql"          tb_parceiros.registro_ativo = 'S' "
sql=$sql"   union all "
sql=$sql"   select tb_parceiros.display_name as parceiro, "
sql=$sql"          tb_parceiros.registro_ativo as parceiro_ativo, "
sql=$sql"          tb_log_de_para.categoria_xml as categoria_xml, "
sql=$sql"          '' as categoria_cap, "
sql=$sql"          '' as departamento, "
sql=$sql"          count(tb_log_de_para.categoria_xml) as produtos_perdidos "
sql=$sql"     from tb_parceiros "
sql=$sql"    inner join tb_log_de_para on "
sql=$sql"          tb_log_de_para.parceiro_id = tb_parceiros.id "
sql=$sql" group by tb_log_de_para.categoria_xml, "
sql=$sql"          tb_parceiros.id "
sql=$sql"        INTO OUTFILE '$output$file_name'"
sql=$sql"        FIELDS TERMINATED BY ';'"
sql=$sql"        LINES TERMINATED BY '\n';"

mysql -e "$sql"

#remover extensao do arquivo
file_with_path=$output$file_name
helper=${file_with_path%.csv}

#criar nome de arquivo.zip
file_with_path_only=${helper##*/}.zip

#move para pasta destino e cria arquivo .zip
cd $output
zip $file_with_path_only $file_name

#remove arquivo .csv
rm -f $file_name

