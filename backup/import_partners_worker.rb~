class ImportPartnersWorker
  @queue = :import_partners_queue
  
  def self.perform
    log = LogImporter.last_execution "all", "ImportPartners"
    end_time = end_time || Time.now
    start_time = start_time || Date.parse('2000/01/01')
    imported_partners = 0
    inserted_partners = 0
    updated_partners = 0   

    if (log.nil? || log.status != LogImporter::STATUS_EXECUTING)
      log = LogImporter.create :importer_name => "ImportPartners", 
              :start_time => Time.now, 
              :status => LogImporter::STATUS_EXECUTING, 
              :requested_start_time => start_time, 
              :requested_end_time => end_time,
              :partner_name => "all",
              :status_messages => []
      has_errors = false

      Legacy::Parceiro.all.each do |legacy|
        begin
          current_partner = Partner.find(:first, :conditions => {:name => legacy.nome.downcase}) 
          partner = current_partner || Partner.new
          save_partner(partner, legacy)
          inserted_partners = inserted_partners + 1 if current_partner.nil?
          updated_partners = updated_partners + 1 unless current_partner.nil?
          imported_partners = imported_partners + 1
        rescue Exception => error
          has_errors = true
          log.status_messages << {:message => error.message, :partner_id => legacy.nil? ? 0 :  legacy.id}
        end
      end

      log.status = has_errors ? LogImporter::STATUS_ERROR :  LogImporter::STATUS_SUCCESS
      log.end_time = Time.now
      log.imported_items = imported_partners
      log.inserted_items = inserted_partners
      log.updated_items = updated_partners
      log.save!
    end
      
   end

  private
  def self.save_partner(partner, legacy)
    partner.legacy_id = legacy.id
    partner.status = legacy.ativo? ? Partner::STATUS_ACTIVE : Partner::STATUS_DEACTIVATED
    partner.deactivated_at = legacy.inativado_em unless legacy.ativo?
    partner.name = legacy.nome
    partner.parser = legacy.class_processor
    partner.url = legacy.url_original || ""
    partner.url_data_source = legacy.url_atualizacao || ""
    partner.active_brand = legacy.logo_ativo
    partner.display_name = legacy.display_name
    partner.active_name = legacy.nome_ativo
        
    partner.save!
  end

end
